name: Setup Environment and Secrets

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      update_secrets:
        description: 'Update secrets from Key Vault'
        required: false
        default: false
        type: boolean

env:
  AZURE_RESOURCE_GROUP: helpsavta-prod-rg
  KEY_VAULT_NAME: helpsavta-production-kv

jobs:
  setup-secrets:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Verify Key Vault access
      run: |
        echo "Verifying access to Key Vault: ${{ env.KEY_VAULT_NAME }}"
        az keyvault show --name ${{ env.KEY_VAULT_NAME }} --query "name" --output tsv

    - name: Get Static Web Apps API Token
      if: github.event.inputs.update_secrets == 'true'
      run: |
        echo "Retrieving Static Web Apps API token..."
        API_TOKEN=$(az staticwebapp secrets list \
          --name helpsavta-production-frontend \
          --query "properties.apiKey" \
          --output tsv)
        
        echo "API_TOKEN=${API_TOKEN}" >> $GITHUB_ENV
        echo "✅ Static Web Apps API token retrieved"

    - name: Validate required secrets
      run: |
        echo "Validating required secrets in Key Vault..."
        
        REQUIRED_SECRETS=(
          "sendgrid-api-key"
          "session-secret"
          "admin-username"
          "admin-password"
          "email-from"
        )
        
        for secret in "${REQUIRED_SECRETS[@]}"; do
          if az keyvault secret show --vault-name ${{ env.KEY_VAULT_NAME }} --name "$secret" --query "name" --output tsv > /dev/null 2>&1; then
            echo "✅ Secret '$secret' exists"
          else
            echo "❌ Secret '$secret' missing"
            exit 1
          fi
        done
        
        echo "✅ All required secrets validated"

    - name: Test database connectivity
      run: |
        echo "Testing database connectivity..."
        
        # This would be run when the container app is deployed
        echo "Database connectivity will be tested during container deployment"
        echo "✅ Database connectivity check scheduled"

    - name: Environment setup summary
      run: |
        echo "🚀 Environment Setup Summary"
        echo "============================"
        echo "✅ Environment: ${{ github.event.inputs.environment }}"
        echo "✅ Resource Group: ${{ env.AZURE_RESOURCE_GROUP }}"
        echo "✅ Key Vault: ${{ env.KEY_VAULT_NAME }}"
        echo "✅ Secrets: Validated"
        echo "============================"