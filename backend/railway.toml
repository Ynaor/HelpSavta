[build]
builder = "NIXPACKS"
buildCommand = "npm ci && npx prisma generate && npm run build"

[deploy]
startCommand = "npx prisma migrate deploy && node dist/server.js"
healthcheckPath = "/health"
healthcheckTimeout = 30
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 3

[environments.production.variables]
NODE_ENV = "production"
PORT = "3001"
DATABASE_URL = "${{Postgres.DATABASE_URL}}"
REDIS_URL = "${{Redis.REDIS_URL}}"
JWT_SECRET = "${{JWT_SECRET}}"
SENDGRID_API_KEY = "${{SENDGRID_API_KEY}}"
SENDGRID_FROM_EMAIL = "${{SENDGRID_FROM_EMAIL}}"
FRONTEND_URL = "${{FRONTEND_URL}}"
SESSION_SECRET = "${{SESSION_SECRET}}"

[environments.staging.variables]
NODE_ENV = "staging"
PORT = "3001"
DATABASE_URL = "${{Postgres.DATABASE_URL}}"
REDIS_URL = "${{Redis.REDIS_URL}}"
JWT_SECRET = "${{JWT_SECRET}}"
SENDGRID_API_KEY = "${{SENDGRID_API_KEY}}"
SENDGRID_FROM_EMAIL = "${{SENDGRID_FROM_EMAIL}}"
FRONTEND_URL = "${{FRONTEND_URL}}"
SESSION_SECRET = "${{SESSION_SECRET}}"